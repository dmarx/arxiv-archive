\section{Theory}
Let \( N^{(\ell)} \) be the number of $(\ell)$ tokens in front of a Markov token, let \( \beta^{(\ell)} \be_{\ell} \) be the corresponding value state. 
state, and let \( p_{k} \) be the Markov transition probability, i.e., $P( k \mid \text{current term})$.

\[
\text{Loss} = \sum_k p_k \left[ \log \left( \sum_{\ell} p_\ell e^{\frac{\beta^{(\ell)}N^{(\ell)}}{e^y+N}}\right) - \frac{\beta^{(\ell)}N^{(\ell)}}{e^y+N} - \log p_k\right].
\]

(I later realized that we should use $e^x\approx 1+x+x^2/2$ and $\log(1+x)\approx x$ to approximate.