\begin{tikzpicture}[node distance=0.5cm]
  \pgfmathsetseed{21}
  \tikzset{
    bigarrow/.style={
      decorate,
      decoration={brace, amplitude=10pt, raise=2pt},
      thick, -latex, -
    }
  }
  \tikzset{layer/.style={draw, rectangle, minimum height=0.8cm, minimum width=1.2cm, align=center}}
  \tikzset{llabel/.style={
    inner sep=0.0cm
  }}
  \tikzset{bigbox/.style={draw, rectangle, inner sep=0.15cm}}
  \tikzset{worker/.style={bigbox, label=above:Minibatch}}
  \tikzset{aggregator/.style={bigbox, label=above:Aggregated}}
  \tikzset{gradient/.style={->, thick, red}}

  \foreach \w in {0,1,2} {
    \node[layer] (layer1-\w) at (2.3*\w, 0) {};
    \node[llabel, left=of layer1-\w, xshift=0.4cm] (label1-\w) {$l_1$};

    \node[layer, below=of layer1-\w] (layer2-\w) {};
    \node[llabel, left=of layer2-\w, xshift=0.4cm] {$l_2$};
    \node[layer, below=of layer2-\w] (layer3-\w) {};
    \node[llabel, left=of layer3-\w, xshift=0.4cm] {$l_3$};

    \ifnum\w=0
      \def\mylength{0.15cm}
    \else
      \ifnum\w=1
        \def\mylength{0.4cm}
      \else
        \def\mylength{0.28cm}
      \fi
    \fi
    \foreach \x in {1,2,3} {
      \pgfmathsetmacro{\Angle}{random(0,360)}
      \draw[gradient] (layer\x-\w.center) -- ++(\Angle:\mylength);
    }

    \node[worker, fit=(label1-\w) (layer1-\w) (layer3-\w)] (worker-\w) {};
  }

  \draw[bigarrow] ([xshift=0.2cm]worker-2.north east) -- ([xshift=0.2cm]worker-2.south east) {};

  \foreach \w in {3} {
    \node[layer] (layer1-\w) at (2.5*\w, 0) {};
    \node[llabel, left=of layer1-\w, xshift=0.4cm] (label1-\w) {$l_1$};

    \node[layer, below=of layer1-\w] (layer2-\w) {};
    \node[llabel, left=of layer2-\w, xshift=0.4cm] {$l_2$};
    \node[layer, below=of layer2-\w] (layer3-\w) {};
    \node[llabel, left=of layer3-\w, xshift=0.4cm] {$l_3$};

    \draw[gradient] (layer1-\w.center) -- ++(0.11,0.11);
    \draw[gradient] (layer2-\w.center) -- ++(0.08,0.08);
    \draw[gradient] (layer3-\w.center) -- ++(-0.1,-0.1);
    \node[aggregator, fit=(label1-\w)(layer1-\w) (layer3-\w)] (worker-\w) {};
  }
\end{tikzpicture}

